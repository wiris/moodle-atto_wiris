YUI.add("moodle-atto_wiris-button",function(e,t){e.namespace("M.atto_wiris").Button=e.Base.create("button",e.M.editor_atto.EditorPlugin,[],{initializer:function(t){if(!t.filter_enabled)return;e.Get.js(M.cfg.wwwroot+"/lib/editor/atto/plugins/wiris/core.js?v="+t.version,function(e){if(!e){var n=function(e){WirisPlugin.IntegrationModel.call(this,e),this.config=e.config};n.prototype=Object.create(WirisPlugin.IntegrationModel&&WirisPlugin.IntegrationModel.prototype),n.prototype.getPath=function(){return M.cfg.wwwroot+"/lib/editor/atto/plugins/wiris"},n.prototype.getLanguage=function(){return this.config.lang},n.prototype.doubleClickHandler=function(e,t){var n=e.classList.contains("Wirisformula");n&&(t.stopPropagation(),WirisPlugin.IntegrationModel.prototype.doubleClickHandler.call(this,e,t))},n.prototype.updateFormula=function(e){WirisPlugin.IntegrationModel.prototype.updateFormula.call(this,e);var t=this.editorObject.get("host"),n=t.textarea.get("value"),r=this.convertSafeMathml(WirisPlugin.Parser.endParse(n,null,this.config.lang,!0));t.textarea.set("value",r),this.editorObject.markUpdated()},n.prototype.callbackFunction=function(){WirisPlugin.IntegrationModel.prototype.callbackFunction.call(this),this.parseContent();var e=this.editorObject.get("host").textarea.ancestor("form");e&&e.on("submit",this.submit,this)},n.prototype.parseContent=function(){var e=this.editorObject.get("host"),t=e.editor.get("innerHTML");t=WirisPlugin.Parser.initParse(t,this.config.lang),e.editor.set("innerHTML",t),this.editorObject.markUpdated()},n.prototype.unParseContent=function(){var e=this.editorObject.get("host"),t=e.textarea.get("value"),n=this.convertSafeMathml(WirisPlugin.Parser.endParse(t,null,this.config.lang,!0));e.textarea.set("value",n)},n.prototype.submit=function(){var e=this.editorObject.get("host"),t=e.editor.get("innerHTML");(t.indexOf("math\u00bb")>=0||t.indexOf("math>")>=0||t.indexOf("$$")>=0)&&e.textarea.set("value",WirisPlugin.Parser.endParseSaveMode(t,null,this.config.lang,!0))},n.prototype.convertSafeMathml=function(e){var t="",n="\u00abmath",r="\u00ab/math\u00bb",i=e.indexOf(n),s=0;while(i!=-1){t+=e.substring(s,i),imageMathmlAttribute=e.indexOf(WirisPlugin.Configuration.get("imageMathmlAttribute")),s=e.indexOf(r,i),s==-1?s=e.length-1:imageMathmlAttribute!=-1?s+=e.indexOf("/>",i):s+=r.length;if(!WirisPlugin.MathML.isMathmlInAttribute(e,i)&&imageMathmlAttribute==-1){var o=e.substring(i,s);t+=WirisPlugin.MathML.safeXmlDecode(o)}else t+=e.substring(i,s);i=e.indexOf(n,s)}return t+=e.substring(s,e.length),t};var r={};r.configurationService=M.cfg.wwwroot+"/filter/wiris/integration/configurationjs.php",r.editorObject=this,r.target=this.get("host").editor.getDOMNode(),r.scriptName="",r.config=t,r.version="unknown",r.environment={},r.environment.editor="Atto",r.environment.editorVersion=t.version,r.environment.moodleCourse=t.moodleCourse;var i=new n(r);i.init(),i.listeners.fire("onTargetReady",{}),WirisPlugin.currentInstance=i;var s=this.get("host");s.plugins.collapse&&s.plugins.collapse._setVisibility(s.plugins.collapse.buttons.collapse)}}.bind(this)),this._addButtons(t);var n=this.get("host");n.on("atto:selectionchanged",function(e){if(typeof e.event=="undefined"){var t=n.editor.get("innerHTML");t=WirisPlugin.Parser.initParse(t,WirisPlugin.currentInstance.config.lang),n.editor.set("innerHTML",t)}}),n._wirisUpdateFromTextArea=n.updateFromTextArea,n.updateFromTextArea=function(){n._wirisUpdateFromTextArea();var e=n.editor.get("innerHTML");try{e=WirisPlugin.Parser.initParse(e,WirisPlugin.currentInstance.config.lang)}catch(t){}n.editor.set("innerHTML",e)},n._wirisupdateOriginal=n.updateOriginal,n.updateOriginal=function(e){n._wirisupdateOriginal();var t=n.textarea.get("value");try{t=WirisPlugin.Parser.endParse(t),t=e._convertSafeMathML(t)}catch(r){}n.textarea.set("value",t)},_convertSafeMathML=function(e){var t="",n="\u00abmath",r="\u00ab/math\u00bb",i=e.indexOf(n),s=0;while(i!=-1){t+=e.substring(s,i),imageMathmlAttribute=e.indexOf(WirisPlugin.Configuration.get("imageMathmlAttribute")),s=e.indexOf(r,i),s==-1?s=e.length-1:imageMathmlAttribute!=-1?s+=e.indexOf("/>",i):s+=r.length;if(!WirisPlugin.MathML.isMathmlInAttribute(e,i)&&imageMathmlAttribute==-1){var o=e.substring(i,s);t+=WirisPlugin.MathML.safeXmlDecode(o)}else t+=e.substring(i,s);i=e.indexOf(n,s)}return t+=e.substring(s,e.length),t}},_addButtons:function(e){parseInt(e.editor_is_active)&&this.addButton({title:"wiris_editor_title",buttonName:"wiris_editor",icon:"formula",iconComponent:"atto_wiris",callback:this._editorButton}),parseInt(e.chemistry_is_active)&&this.addButton({title:"wiris_chem_editor_title",buttonName:"wiris_chem_editor",icon:"chem",iconComponent:"atto_wiris",callback:this._chemButton})},_editorButton:function(){WirisPlugin.currentInstance.editorObject=this,WirisPlugin.currentInstance.setTarget(this.get("host").editor.getDOMNode()),WirisPlugin.currentInstance.core.getCustomEditors().disable(),WirisPlugin.currentInstance.openNewFormulaEditor()},_chemButton:function(){WirisPlugin.currentInstance.editorObject=this,WirisPlugin.currentInstance.setTarget(this.get("host").editor.getDOMNode()),WirisPlugin.currentInstance.getCore().getCustomEditors().enable("chemistry"),WirisPlugin.currentInstance.openNewFormulaEditor()}})},"@VERSION@",{requires:["moodle-editor_atto-plugin","get"]});
