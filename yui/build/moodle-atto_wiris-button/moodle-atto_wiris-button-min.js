YUI.add("moodle-atto_wiris-button",function(t,i){t.namespace("M.atto_wiris").Button=t.Base.create("button",t.M.editor_atto.EditorPlugin,[],{initializer:function(r){if(r.filter_enabled){t.Get.js(M.cfg.wwwroot+"/lib/editor/atto/plugins/wiris/core.js?v="+r.version,function(t){var i,e,n;t||((i=function(t){WirisPlugin.IntegrationModel.call(this,t),this.config=t.config}).prototype=Object.create(WirisPlugin.IntegrationModel&&WirisPlugin.IntegrationModel.prototype),i.prototype.getPath=function(){return M.cfg.wwwroot+"/lib/editor/atto/plugins/wiris"},i.prototype.getLanguage=function(){return this.config.lang},i.prototype.doubleClickHandler=function(t,i){t.classList.contains("Wirisformula")&&(i.stopPropagation(),WirisPlugin.IntegrationModel.prototype.doubleClickHandler.call(this,t,i))},i.prototype.updateFormula=function(t){var i,e,n;WirisPlugin.IntegrationModel.prototype.updateFormula.call(this,t),e=(i=this.editorObject.get("host")).textarea.get("value"),n=this.convertSafeMathml(WirisPlugin.Parser.endParse(e,null,this.config.lang,!0)),i.textarea.set("value",n),this.editorObject.markUpdated()},i.prototype.callbackFunction=function(){WirisPlugin.IntegrationModel.prototype.callbackFunction.call(this),this.parseContent();var t=this.editorObject.get("host").textarea.ancestor("form");t&&t.on("submit",this.submit,this)},i.prototype.parseContent=function(){var t=this.editorObject.get("host"),i=t.editor.get("innerHTML");i=WirisPlugin.Parser.initParse(i,this.config.lang),t.editor.set("innerHTML",i),this.editorObject.markUpdated()},i.prototype.unParseContent=function(){var t=this.editorObject.get("host"),i=t.textarea.get("value"),e=this.convertSafeMathml(WirisPlugin.Parser.endParse(i,null,this.config.lang,!0));t.textarea.set("value",e)},i.prototype.submit=function(){var t=this.editorObject.get("host"),i=t.editor.get("innerHTML");(0<=i.indexOf("math»")||0<=i.indexOf("math>"))&&t.textarea.set("value",WirisPlugin.Parser.endParse(i,null,this.config.lang,!0))},i.prototype.convertSafeMathml=function(t){for(var i,e="",n="«math",r="«/math»",o=t.indexOf(n),a=0;-1!=o;)e+=t.substring(a,o),imageMathmlAttribute=t.indexOf(WirisPlugin.Configuration.get("imageMathmlAttribute")),-1==(a=t.indexOf(r,o))?a=t.length-1:-1!=imageMathmlAttribute?a+=t.indexOf("/>",o):a+=r.length,WirisPlugin.MathML.isMathmlInAttribute(t,o)||-1!=imageMathmlAttribute?e+=t.substring(o,a):(i=t.substring(o,a),e+=WirisPlugin.MathML.safeXmlDecode(i)),o=t.indexOf(n,a);return e+=t.substring(a,t.length)},(e={}).configurationService=M.cfg.wwwroot+"/filter/wiris/integration/configurationjs.php",e.editorObject=this,e.target=this.get("host").editor.getDOMNode(),e.scriptName="",e.config=r,(n=new i(e)).init(),n.listeners.fire("onTargetReady",{}),WirisPlugin.currentInstance=n)}.bind(this)),this._addButtons(r);var n=this.get("host");n.on("atto:selectionchanged",function(t){if("undefined"==typeof t.event){var i=n.editor.get("innerHTML");i=WirisPlugin.Parser.initParse(i,WirisPlugin.currentInstance.config.lang),n.editor.set("innerHTML",i)}}),n._wirisUpdateFromTextArea=n.updateFromTextArea,n.updateFromTextArea=function(){n._wirisUpdateFromTextArea();var t=n.editor.get("innerHTML");try{t=WirisPlugin.Parser.initParse(t,WirisPlugin.currentInstance.config.lang)}catch(i){}n.editor.set("innerHTML",t)},n._wirisupdateOriginal=n.updateOriginal,n.updateOriginal=function(t){n._wirisupdateOriginal();var i=n.textarea.get("value");try{i=WirisPlugin.Parser.endParse(i),i=t._convertSafeMathML(i)}catch(e){}n.textarea.set("value",i)},_convertSafeMathML=function(t){for(var i,e="",n="«math",r="«/math»",o=t.indexOf(n),a=0;-1!=o;)e+=t.substring(a,o),imageMathmlAttribute=t.indexOf(WirisPlugin.Configuration.get("imageMathmlAttribute")),-1==(a=t.indexOf(r,o))?a=t.length-1:-1!=imageMathmlAttribute?a+=t.indexOf("/>",o):a+=r.length,WirisPlugin.MathML.isMathmlInAttribute(t,o)||-1!=imageMathmlAttribute?e+=t.substring(o,a):(i=t.substring(o,a),e+=WirisPlugin.MathML.safeXmlDecode(i)),o=t.indexOf(n,a);return e+=t.substring(a,t.length)}}},_addButtons:function(t){parseInt(t.editor_is_active)&&this.addButton({title:"wiris_editor_title",buttonName:"wiris_editor",icon:"formula",iconComponent:"atto_wiris",callback:this._editorButton}),parseInt(t.chemistry_is_active)&&this.addButton({title:"wiris_chem_editor_title",buttonName:"wiris_chem_editor",icon:"chem",iconComponent:"atto_wiris",callback:this._chemButton});var i=this.get("host");i.plugins.collapse&&i.plugins.collapse._setVisibility(i.plugins.collapse.buttons.collapse)},_editorButton:function(){WirisPlugin.currentInstance.editorObject=this,WirisPlugin.currentInstance.setTarget(this.get("host").editor.getDOMNode()),WirisPlugin.currentInstance.core.getCustomEditors().disable(),WirisPlugin.currentInstance.openNewFormulaEditor()},_chemButton:function(){WirisPlugin.currentInstance.editorObject=this,WirisPlugin.currentInstance.setTarget(this.get("host").editor.getDOMNode()),WirisPlugin.currentInstance.getCore().getCustomEditors().enable("chemistry"),WirisPlugin.currentInstance.openNewFormulaEditor()}})},"@VERSION@",{requires:["moodle-editor_atto-plugin","get"]});