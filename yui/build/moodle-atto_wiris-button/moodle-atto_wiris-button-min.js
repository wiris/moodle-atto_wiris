YUI.add("moodle-atto_wiris-button",function(t,i){t.namespace("M.atto_wiris").Button=t.Base.create("button",t.M.editor_atto.EditorPlugin,[],{initializer:function(n){if(n.filter_enabled){t.Get.js(M.cfg.wwwroot+"/lib/editor/atto/plugins/wiris/devkit/core.js?v="+n.version,function(t){var i,e,r;t||((i=function(t){WirisPlugin.IntegrationModel.call(this,t),this.config=t.config}).prototype=Object.create(WirisPlugin.IntegrationModel&&WirisPlugin.IntegrationModel.prototype),i.prototype.getPath=function(){return M.cfg.wwwroot+"/lib/editor/atto/plugins/wiris"},i.prototype.getLanguage=function(){return this.config.lang},i.prototype.doubleClickHandler=function(t,i){t.classList.contains("Wirisformula")&&(i.stopPropagation(),WirisPlugin.IntegrationModel.prototype.doubleClickHandler.call(this,t,i))},i.prototype.updateFormula=function(t){var i,e,r;WirisPlugin.IntegrationModel.prototype.updateFormula.call(this,t),e=(i=this.editorObject.get("host")).textarea.get("value"),r=this.convertSafeMathml(WirisPlugin.Parser.endParse(e,null,this.config.lang,!0)),i.textarea.set("value",r),this.editorObject.markUpdated()},i.prototype.callbackFunction=function(){WirisPlugin.IntegrationModel.prototype.callbackFunction.call(this),this.parseContent();var t=this.editorObject.get("host").textarea.ancestor("form");t&&t.on("submit",this.submit,this)},i.prototype.parseContent=function(){var t=this.editorObject.get("host"),i=t.editor.get("innerHTML");i=WirisPlugin.Parser.initParse(i,this.config.lang),t.editor.set("innerHTML",i),this.editorObject.markUpdated()},i.prototype.unParseContent=function(){var t=this.editorObject.get("host"),i=t.textarea.get("value"),e=this.convertSafeMathml(WirisPlugin.Parser.endParse(i,null,this.config.lang,!0));t.textarea.set("value",e)},i.prototype.submit=function(){var t=this.editorObject.get("host"),i=t.editor.get("innerHTML");(0<=i.indexOf("math»")||0<=i.indexOf("math>"))&&t.textarea.set("value",WirisPlugin.Parser.endParse(i,null,this.config.lang,!0))},i.prototype.convertSafeMathml=function(t){for(var i,e="",r="«math",n="«/math»",o=t.indexOf(r),a=0;-1!=o;)e+=t.substring(a,o),imageMathmlAttribute=t.indexOf(WirisPlugin.Configuration.get("imageMathmlAttribute")),-1==(a=t.indexOf(n,o))?a=t.length-1:-1!=imageMathmlAttribute?a+=t.indexOf("/>",o):a+=n.length,WirisPlugin.MathML.isMathmlInAttribute(t,o)||-1!=imageMathmlAttribute?e+=t.substring(o,a):(i=t.substring(o,a),e+=WirisPlugin.MathML.safeXmlDecode(i)),o=t.indexOf(r,a);return e+=t.substring(a,t.length)},(e={}).editorObject=this,e.target=this.get("host").editor.getDOMNode(),e.scriptName="",e.config=n,e.serviceProviderProperties={},e.serviceProviderProperties.URI="https://www.wiris.net/demo/plugins/app",e.serviceProviderProperties.server="java",e.version="7.27.0",e.isMoodle=!1,(r=new i(e)).init(),r.listeners.fire("onTargetReady",{}),WirisPlugin.currentInstance=r)}.bind(this)),this._addButtons(n);var r=this.get("host");r.on("atto:selectionchanged",function(t){if("undefined"==typeof t.event){var i=r.editor.get("innerHTML");i=WirisPlugin.Parser.initParse(i,WirisPlugin.currentInstance.config.lang),r.editor.set("innerHTML",i)}}),r._wirisUpdateFromTextArea=r.updateFromTextArea,r.updateFromTextArea=function(){r._wirisUpdateFromTextArea();var t=r.editor.get("innerHTML");try{t=WirisPlugin.Parser.initParse(t,WirisPlugin.currentInstance.config.lang)}catch(i){}r.editor.set("innerHTML",t)},r._wirisupdateOriginal=r.updateOriginal,r.updateOriginal=function(t){r._wirisupdateOriginal();var i=r.textarea.get("value");try{i=WirisPlugin.Parser.endParse(i),i=t._convertSafeMathML(i)}catch(e){}r.textarea.set("value",i)},_convertSafeMathML=function(t){for(var i,e="",r="«math",n="«/math»",o=t.indexOf(r),a=0;-1!=o;)e+=t.substring(a,o),imageMathmlAttribute=t.indexOf(WirisPlugin.Configuration.get("imageMathmlAttribute")),-1==(a=t.indexOf(n,o))?a=t.length-1:-1!=imageMathmlAttribute?a+=t.indexOf("/>",o):a+=n.length,WirisPlugin.MathML.isMathmlInAttribute(t,o)||-1!=imageMathmlAttribute?e+=t.substring(o,a):(i=t.substring(o,a),e+=WirisPlugin.MathML.safeXmlDecode(i)),o=t.indexOf(r,a);return e+=t.substring(a,t.length)}}},_addButtons:function(t){parseInt(t.editor_is_active)&&this.addButton({title:"wiris_editor_title",buttonName:"wiris_editor",icon:"formula",iconComponent:"atto_wiris",callback:this._editorButton}),parseInt(t.chemistry_is_active)&&this.addButton({title:"wiris_chem_editor_title",buttonName:"wiris_chem_editor",icon:"chem",iconComponent:"atto_wiris",callback:this._chemButton});var i=this.get("host");i.plugins.collapse&&i.plugins.collapse._setVisibility(i.plugins.collapse.buttons.collapse)},_editorButton:function(){WirisPlugin.currentInstance.editorObject=this,WirisPlugin.currentInstance.setTarget(this.get("host").editor.getDOMNode()),WirisPlugin.currentInstance.core.getCustomEditors().disable(),WirisPlugin.currentInstance.openNewFormulaEditor()},_chemButton:function(){WirisPlugin.currentInstance.editorObject=this,WirisPlugin.currentInstance.setTarget(this.get("host").editor.getDOMNode()),WirisPlugin.currentInstance.getCore().getCustomEditors().enable("chemistry"),WirisPlugin.currentInstance.openNewFormulaEditor()}})},"@VERSION@",{requires:["moodle-editor_atto-plugin","get"]});